{% extends 'base.html' %}
{% load static %}
{% block content %}


<table class="table table-hover">
    {% csrf_token %}
    <thead>
        <tr>
            <th>SN</th>
            <th>Department Name</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody>
        {% for department in department %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ department.name }}</td>
            <td><button class="edit-button" data-id="{{ department.id }}">Edit</button></td>
            <td><button class="delete-button" data-id="{{ department.id }}">Delete</button></td>
        </tr>
        {% endfor %}
    </tbody>
  </table>
<!-- Button trigger modal -->
<button type="button" class="btn btn-primary btn-lg btn-block" data-toggle="modal" data-target="#addModal">
    Create new department
  </button>
  
  <!-- Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">New department name:</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <input type="name" class="addDepartmentform"  placeholder="Enter department name here :">                
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const apiUrl = '/api/departments/';

    $(document).ready(function () {
        // Event listener for the "Edit" button
        $(".edit-button").click(function () {
            var departmentId = $(this).data("id");
            // Fetch department data using AJAX and populate the modal for editing
            $.ajax({
                url: apiUrl + departmentId + '/',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    $('#addDepartmentId').val(data.id);
                    $('#addName').val(data.name);
                    $('#modal-default').modal('show');
                },
                error: function (xhr, status, error) {
                    console.error("Error:", error);
                }
            });
        });

        // Event listener for the "Delete" button
        $(".delete-button").click(function () {
    var departmentId = $(this).data("id");

    // Get the CSRF token from the page's meta tag
    var csrfToken = $('meta[name=csrf-token]').attr("content");

    // Send a DELETE request to delete the department with the CSRF token included
    $.ajax({
        url: apiUrl + departmentId + '/',
        method: 'DELETE',
        headers: {
            "X-CSRFToken": csrfToken,
        },
        success: function () {
            // Reload the page or update the department list
            location.reload();
        },
        error: function (xhr, status, error) {
            console.error("Error:", error);
        }
    });
});

        // Event listener for the "Save changes" button in the modal
        $("#save-btn").click(function () {
            var formData = $("#addDepartmentForm").serialize();
            var departmentId = $('#addDepartmentId').val();
            var method = departmentId ? 'PUT' : 'POST'; // Determine if it's an edit or add operation

            $.ajax({
                url: departmentId ? apiUrl + departmentId + '/' : apiUrl,
                method: method,
                data: formData,
                success: function () {
                    // Reload the page or update the department list
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.error("Error:", error);
                }
            });
        });
    });
</script>
  


{% endblock %}
