{% extends 'base.html' %}
{% load static %}
{% block content %}
  <h1>Department Information</h1>
    <table>
        {% csrf_token %}

        <tr>
            <th>SN</th>
            <th>Department Name</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
   
        {% for department in department %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ department.name }}</td>
            <td><button class="edit-button" data-id="{{ department.id }}">Edit</button></td>
            <td><button class="delete-button" data-id="{{ department.id }}">Delete</button></td>
        </tr>
            {% endfor %}
       


    </table>
    <form id="departmentForm">
        {% csrf_token %}
        <fieldset>
            <legend >Add department here : </legend>
            <label for="name">Department Name:</label>
            <input type="text" id="name" name="name" required><br><br>
            <input type="submit" value="Add Department">
        </fieldset>    
    </form>

    <!-- The Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2>Edit Department</h2>
        <form id="editDepartmentForm">
            {% csrf_token %}
        <input type="hidden" id="editDepartmentId" name="id" value="">
        <label for="editName">Department Name:</label>
        <input type="text" id="editName" name="name" required><br><br>
        <button type="submit">Save</button>
        </form>
        </div>
    </div>
  




<style>
    table{
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
        border: 1px solid #ddd;
    }
    th, td {
    text-align: left;
    padding: 16px;
    }

    tr:nth-child(even) {
        background-color: #f3f3f3;    }
    fieldset {
      background-color: #eeeeee;
    }
    
    legend {
      background-color: gray;
      color: white;
      padding: 5px 10px;
    }
    
    input {
      margin: 5px;
    }
        /* Modal styles */
    .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
    background-color: #fff;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 50%;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
    }

    .close {
    float: right;
    cursor: pointer;
    font-size: 24px;
    }
</style>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Handle form submission using AJAX
    $('#departmentForm').submit(function (event) {
      event.preventDefault();

      const formData = $(this).serializeArray();
      const jsonData = {};
      formData.forEach(item => {
        jsonData[item.name] = item.value;
      });

      const apiUrl = '/api/departments/';
      $.ajax({
        url: apiUrl,
        type: 'POST',
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
        contentType: 'application/json',
        data: JSON.stringify(jsonData),
        success: function (data) {
          location.reload();
        },
        error: function (error) {
          console.error('Error:', error);
        }
      });
    });


    // Handle edit button click to open the modal and fetch department data
    $(document).on("click", ".edit-button", function () {
        var departmentId = $(this).data("id");
        console.log("Edit button clicked for department ID: " + departmentId);

        // Fetch department data using AJAX (replace with your API endpoint)
        $.ajax({
            url: "/api/departments/" + departmentId + "/",
            type: "GET",
            success: function (data) {
            // Populate the modal fields with department data
            $("#editDepartmentId").val(data.id);
            $("#editName").val(data.name);

            // Show the modal
            $("#editModal").css("display", "block");

            // Handle form submission for editing within this click event handler
            $("#editDepartmentForm").submit(function (event) {
                event.preventDefault();

                // Get the updated department data from the form
                var updatedDepartmentId = $("#editDepartmentId").val();
                var updatedName = $("#editName").val();

                // Create an object with the updated data
                var updatedData = {
                id: updatedDepartmentId,
                name: updatedName,
                };

                // Make an AJAX request to update the department data
                $.ajax({
                url: "/api/departments/" + updatedDepartmentId + "/", // Replace with your API endpoint
                type: "PUT", // Use PUT request to update data
                data: JSON.stringify(updatedData),
                contentType: "application/json",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}", // Replace with your Django CSRF token
                },
                success: function (data) {
                    // Update the department data on the page (e.g., update the table row)
                    // You may implement this based on your UI structure
                    console.log("Department updated successfully:", data);

                    // Close the modal
                    $("#editModal").css("display", "none");
                    //reload
                    location.reload();
                },
                error: function (error) {
                    console.error("Error updating department data:", error);
                },
                });
            });
            },
            error: function (error) {
            console.error("Error fetching department data:", error);
            },
        });
        });

        // Handle modal close button click
        $("#closeModal").click(function () {
        $("#editModal").css("display", "none");
        });

    // Handle delete button click and reload
    $(document).on("click", ".delete-button", function () {
      const departmentId = $(this).data("id");
      console.log("Delete button clicked for department ID: " + departmentId);
      // Handle delete button click (e.g., show a confirmation dialog)
      // You can make an AJAX request to delete the department.
      if (confirm("Are you sure you want to delete this department?")) {
        const apiUrl = `/api/departments/${departmentId}/`;
        $.ajax({
          url: apiUrl,
          type: 'DELETE',
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
          },
          success: function (data) {
            location.reload();
          },
          error: function (error) {
            console.error('Error:', error);
          }
        });
      }
    });
  </script>
{% endblock %}