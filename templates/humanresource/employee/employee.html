{% extends 'base.html' %}
{% load static %}
{% block content %}
<h1>Employee Information</h1>
<table>
    {% csrf_token %}
    <tr>
        <th>SN</th>
        <th>Employee Name</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    {% for employee in employees %}
    <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ employee.name }}</td>
        <td><button class="edit-button" data-id="{{ employee.id }}">Edit</button></td>
        <td><button class="delete-button" data-id="{{ employee.id }}">Delete</button></td>
    </tr>
    {% endfor %}
</table>

<!-- Add Employee Button -->
<button class="add-button" data-id="addEmployee">Create new employee</button>
<!-- The Modal for Adding/Editing Employee -->
<div id="employeeModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeEmployeeModal">&times;</span>
        <h2 id="employeeModalTitle">Add Employee</h2>
        <form id="employeeForm">
            {% csrf_token %}
            <input type="hidden" id="editEmployeeId" name="employee_id" value="">
            
            <!-- Basic Info -->
            <label for="editName">Name:</label>
            <input type="text" id="editName" name="name" required><br><br>
            
            <label for="editDateOfBirth">Date of Birth:</label>
            <input type="text" id="editDateOfBirth" name="date_of_birth"><br><br>
            
            <label for="editBloodGroup">Blood Group:</label>
            <input type="text" id="editBloodGroup" name="blood_group"><br><br>
            
            <label for="editNationality">Nationality:</label>
            <input type="text" id="editNationality" name="nationality"><br><br>
            
            <label for="editGender">Gender:</label>
            <select id="editGender" name="gender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select><br><br>
            
            <label for="editMaritalStatus">Marital Status:</label>
            <select id="editMaritalStatus" name="marital">
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Legal Cohabitant">Legal Cohabitant</option>
                <option value="Widower">Widower</option>
                <option value="Divorced">Divorced</option>
            </select><br><br>
            
            <label for="editCitizenNumber">Citizen Number:</label>
            <input type="text" id="editCitizenNumber" name="citizen_number"><br><br>
            
            <label for="editPanNumber">PAN Number:</label>
            <input type="text" id="editPanNumber" name="pan_number"><br><br>
            
            <label for="editEmployeeNote">Employee Note:</label>
            <input type="text" id="editEmployeeNote" name="employee_note"><br><br>
            
            <!-- Contact Info -->
            <label for="editAddress">Address:</label>
            <input type="text" id="editAddress" name="address"><br><br>
            
            <label for="editEmail">Email:</label>
            <input type="text" id="editEmail" name="email"><br><br>
            
            <label for="editContact">Contact:</label>
            <input type="text" id="editContact" name="contact"><br><br>
            
            <label for="editWorkPhoneNumber">Work Phone Number:</label>
            <input type="text" id="editWorkPhoneNumber" name="work_phone_number"><br><br>
            
            <label for="editWorkEmail">Work Email:</label>
            <input type="text" id="editWorkEmail" name="work_email"><br><br>
            
            <!-- Guardian Info -->
            <label for="editGuardianName">Guardian Name:</label>
            <input type="text" id="editGuardianName" name="guardian_name"><br><br>
            
            <label for="editGuardianRelation">Guardian Relation:</label>
            <input type="text" id="editGuardianRelation" name="guardian_relation"><br><br>
            
            <label for="editGuardianAddress">Guardian Address:</label>
            <input type="text" id="editGuardianAddress" name="guardian_address"><br><br>
            
            <label for="editGuardianPhoneNumber">Guardian Phone Number:</label>
            <input type="text" id="editGuardianPhoneNumber" name="guardian_phone_number"><br><br>
            
            <!-- Job Responsibility -->
            <label for="editJobPosition">Job Position:</label>
            <input type="text" id="editJobPosition" name="job_position"><br><br>
            
            <label for="editDepartment">Department:</label>
            <select id="editDepartment" name="department">
                <!-- Populate this dropdown with department options -->
            </select><br><br>
            
            <label for="editFired">Fired:</label>
            <input type="checkbox" id="editFired" name="fired"><br><br>
            
            <label for="editJoinDate">Join Date:</label>
            <input type="text" id="editJoinDate" name="join_date"><br><br>
            
            <label for="editLeftDate">Left Date:</label>
            <input type="text" id="editLeftDate" name="left_date"><br><br>
            
            <label for="editBranch">Branch:</label>
            <input type="text" id="editBranch" name="branch"><br><br>
            
            <label for="editGrade">Grade:</label>
            <input type="text" id="editGrade" name="grade"><br><br>
            
            <label for="editRatings">Ratings:</label>
            <input type="text" id="editRatings" name="ratings"><br><br>
            
            <!-- Quarter Benefits -->
            <label for="editStayInQuarters">Stay in Quarters:</label>
            <input type="checkbox" id="editStayInQuarters" name="stay_in_quarters"><br><br>
            
            <label for="editEmployeeType">Employee Type:</label>
            <input type="text" id="editEmployeeType" name="employee_type"><br><br>
            
            <label for="editOutsourceCompany">Outsource Company:</label>
            <input type="text" id="editOutsourceCompany" name="outsource_company"><br><br>
            
            <label for="editSpecialization">Specialization:</label>
            <textarea id="editSpecialization" name="specialization" rows="4" cols="50"></textarea><br><br>
            
            <label for="editTermsAndCondition">Terms and Condition:</label>
            <textarea id="editTermsAndCondition" name="terms_and_condition" rows="4" cols="50"></textarea><br><br>
            
            <!-- Save Button -->
            <button type="submit" id="editEmployeeSubmitButton">Save</button>
        </form>
    </div>

<style>
    table {
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
        border: 1px solid #ddd;
    }

    th, td {
        text-align: left;
        padding: 16px;
    }

    tr:nth-child(even) {
        background-color: #f3f3f3;
    }

    fieldset {
        background-color: #eeeeee;
    }

    legend {
        background-color: gray;
        color: white;
        padding: 5px 10px;
    }

    input {
        margin: 5px;
    }

    /* Modal styles */            

    .modal {
        display: none;
         
        overflow-y: auto;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
    }

    .close {
        float: right;
        cursor: pointer;
        font-size: 24px;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Show the Employee Modal when the modal is triggered
        $('#employeeModal').on('shown.bs.modal', function () {
            // Clear the employee ID input
            $('#editEmployeeId').val('');
            // Clear the employee name input
            $('#editName').val('');
            // Clear other employee fields as needed
        });

        // Handle form submission for both adding and editing employees
        $('#employeeForm').submit(function (event) {
            event.preventDefault();
            // Prepare the employee data for addition/editing
            const employeeId = $('#editEmployeeId').val();
            const employeeName = $('#editName').val();
            const employeeDateOfBirth = $('#editDateOfBirth').val();
            const employeeBloodGroup = $('#editBloodGroup').val();
            const employeeNationality = $('#editNationality').val();
            const employeeGender = $('#editGender').val();
            const employeeMaritalStatus = $('#editMaritalStatus').val();
            const employeeCitizenNumber = $('#editCitizenNumber').val();
            const employeePanNumber = $('#editPanNumber').val();
            const employeeNote = $('#editEmployeeNote').val();
            const employeeAddress = $('#editAddress').val();
            const employeeEmail = $('#editEmail').val();
            const employeeContact = $('#editContact').val();
            const employeeWorkPhoneNumber = $('#editWorkPhoneNumber').val();
            const employeeWorkEmail = $('#editWorkEmail').val();
            const guardianName = $('#editGuardianName').val();
            const guardianRelation = $('#editGuardianRelation').val();
            const guardianAddress = $('#editGuardianAddress').val();
            const guardianPhoneNumber = $('#editGuardianPhoneNumber').val();
            const jobPosition = $('#editJobPosition').val();
            const department = $('#editDepartment').val();
            const fired = $('#editFired').is(':checked');
            const joinDate = $('#editJoinDate').val();
            const leftDate = $('#editLeftDate').val();
            const branch = $('#editBranch').val();
            const grade = $('#editGrade').val();
            const ratings = $('#editRatings').val();
            const stayInQuarters = $('#editStayInQuarters').is(':checked');
            const employeeType = $('#editEmployeeType').val();
            const outsourceCompany = $('#editOutsourceCompany').val();
            const specialization = $('#editSpecialization').val();
            const termsAndCondition = $('#editTermsAndCondition').val();

            const employeeData = {
                id: employeeId,
                name: employeeName,
                date_of_birth: employeeDateOfBirth,
                blood_group: employeeBloodGroup,
                nationality: employeeNationality,
                gender: employeeGender,
                marital: employeeMaritalStatus,
                citizen_number: employeeCitizenNumber,
                pan_number: employeePanNumber,
                employee_note: employeeNote,
                address: employeeAddress,
                email: employeeEmail,
                contact: employeeContact,
                work_phone_number: employeeWorkPhoneNumber,
                work_email: employeeWorkEmail,
                guardian_name: guardianName,
                guardian_relation: guardianRelation,
                guardian_address: guardianAddress,
                guardian_phone_number: guardianPhoneNumber,
                job_position: jobPosition,
                department: department,
                fired: fired,
                join_date: joinDate,
                left_date: leftDate,
                branch: branch,
                grade: grade,
                ratings: ratings,
                stay_in_quarters: stayInQuarters,
                employee_type: employeeType,
                outsource_company: outsourceCompany,
                specialization: specialization,
                terms_and_condition: termsAndCondition,
                // Add other fields as needed
            };

            // Determine whether to use POST (add) or PUT (edit) based on the presence of employeeId
            const requestType = employeeId ? 'PUT' : 'POST';
            const apiUrl = employeeId ? `/api/employees/${employeeId}/` : '/api/employees/';

            $.ajax({
                url: apiUrl,
                type: requestType,
                data: JSON.stringify(employeeData),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // Replace with your Django CSRF token
                },
                success: function (data) {
                    // Handle success (e.g., close modal and refresh employee list)
                    $('#employeeModal').modal('hide');
                    location.reload(); // Reload the page or update the employee list dynamically
                },
                error: function (error) {
                    // Handle errors (e.g., display error message)
                    console.log(error);
                }
            });
        });

        // Handle edit button click to open the modal and fetch employee data
        $(document).on("click", ".edit-button", function () {
            var employeeId = $(this).data("id");
            console.log("Edit button clicked for employee ID: " + employeeId);

            // Fetch employee data using AJAX (replace with your API endpoint)
            $.ajax({
                url: "/api/employees/" + employeeId + "/",
                type: "GET",
                success: function (data) {
                    // Populate the modal fields with employee data
                    $("#editEmployeeId").val(data.id);
                    $("#editName").val(data.name);
                    $("#editDateOfBirth").val(data.date_of_birth);
                    $("#editBloodGroup").val(data.blood_group);
                    $("#editNationality").val(data.nationality);
                    $("#editGender").val(data.gender);
                    $("#editMaritalStatus").val(data.marital);
                    $("#editCitizenNumber").val(data.citizen_number);
                    $("#editPanNumber").val(data.pan_number);
                    $("#editEmployeeNote").val(data.employee_note);
                    $("#editAddress").val(data.address);
                    $("#editEmail").val(data.email);
                    $("#editContact").val(data.contact);
                    $("#editWorkPhoneNumber").val(data.work_phone_number);
                    $("#editWorkEmail").val(data.work_email);
                    $("#editGuardianName").val(data.guardian_name);
                    $("#editGuardianRelation").val(data.guardian_relation);
                    $("#editGuardianAddress").val(data.guardian_address);
                    $("#editGuardianPhoneNumber").val(data.guardian_phone_number);
                    $("#editJobPosition").val(data.job_position);
                    $("#editDepartment").val(data.department);
                    $("#editFired").prop('checked', data.fired);
                    $("#editJoinDate").val(data.join_date);
                    $("#editLeftDate").val(data.left_date);
                    $("#editBranch").val(data.branch);
                    $("#editGrade").val(data.grade);
                    $("#editRatings").val(data.ratings);
                    $("#editStayInQuarters").prop('checked', data.stay_in_quarters);
                    $("#editEmployeeType").val(data.employee_type);
                    $("#editOutsourceCompany").val(data.outsource_company);
                    $("#editSpecialization").val(data.specialization);
                    $("#editTermsAndCondition").val(data.terms_and_condition);

                    // Show the modal
                    $("#employeeModal").modal("show");
                },
                error: function (error) {
                    console.error("Error fetching employee data:", error);
                },
            });
        });

        // Handle modal close button click
        $("#closeEmployeeModal").click(function () {
            $("#employeeModal").modal("hide");
        });

        // Handle delete button click and reload
        $(document).on("click", ".delete-button", function () {
            const employeeId = $(this).data("id");
            console.log("Delete button clicked for employee ID: " + employeeId);
            // Handle delete button click (e.g., show a confirmation dialog)
            // You can make an AJAX request to delete the employee.
            if (confirm("Are you sure you want to delete this employee?")) {
                const apiUrl = `/api/employees/${employeeId}/`;
                $.ajax({
                    url: apiUrl,
                    type: 'DELETE',
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    success: function (data) {
                        location.reload();
                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            }
        });

        // Handle add button click to open the modal for adding a new employee
        $(document).on("click", ".add-button", function () {
            console.log("Add button is clicked");
            resetForm();
            // Show the modal
            $("#employeeModal").css("display", "block");

        });

        // Function to reset the form
        function resetForm() {
            $('#editEmployeeId').val('');
            $('#editName').val('');
            $('#editDateOfBirth').val('');
            $('#editBloodGroup').val('');
            $('#editNationality').val('');
            $('#editGender').val('');
            $('#editMaritalStatus').val('');
            $('#editCitizenNumber').val('');
            $('#editPanNumber').val('');
            $('#editEmployeeNote').val('');
            $('#editAddress').val('');
            $('#editEmail').val('');
            $('#editContact').val('');
            $('#editWorkPhoneNumber').val('');
            $('#editWorkEmail').val('');
            $('#editGuardianName').val('');
            $('#editGuardianRelation').val('');
            $('#editGuardianAddress').val('');
            $('#editGuardianPhoneNumber').val('');
            $('#editJobPosition').val('');
            $('#editDepartment').val('');
            $('#editFired').prop('checked', false);
            $('#editJoinDate').val('');
            $('#editLeftDate').val('');
            $('#editBranch').val('');
            $('#editGrade').val('');
            $('#editRatings').val('');
            $('#editStayInQuarters').prop('checked', false);
            $('#editEmployeeType').val('');
            $('#editOutsourceCompany').val('');
            $('#editSpecialization').val('');
            $('#editTermsAndCondition').val('');
            // Reset other fields as needed
        }
    });
</script>


{% endblock %}
